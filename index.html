<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Recipe Cost Estimator</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{ --blue:#1f66c1; --text:#111; --muted:#666; --border:#ddd; --bg:#fafafa; --accent:#e5f0ff; --danger:#c11f3a;}
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    color:var(--text);
    background:#fff;
  }
  main{
    max-width:900px;
    margin:0 auto;
    padding:24px 16px 40px;
  }
  h1{
    font-size:26px;
    margin:0 0 8px;
  }
  p{margin:0 0 10px; line-height:1.5;}
  .muted{color:var(--muted);font-size:13px;}
  .tagline{font-size:15px;margin-bottom:18px;}
  .card{
    border:1px solid var(--border);
    border-radius:10px;
    padding:16px 16px 18px;
    background:var(--bg);
    margin-bottom:18px;
  }
  .card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;}
  .card-title{font-weight:600;font-size:15px;}
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 9px;
    border-radius:999px;
    background:#fff;
    border:1px solid var(--border);
    color:var(--muted);
    font-size:12px;
  }
  .pill-dot{
    width:6px;height:6px;border-radius:999px;background:var(--blue);
  }
  label{font-size:13px;display:block;margin-bottom:4px;}
  input,select,textarea{
    font-family:inherit;
    font-size:14px;
  }
  input[type="text"],input[type="number"],select,textarea{
    border:1px solid var(--border);
    border-radius:6px;
    padding:7px 8px;
    width:100%;
  }
  textarea{resize:vertical;min-height:60px;}
  .grid{display:grid;gap:10px;}
  .grid-2{grid-template-columns:1.5fr 1fr;}
  .grid-3{grid-template-columns:2fr 1fr 1fr;}
  .controls-inline{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .controls-inline > *{flex:1 1 auto;}
  .controls-inline > .tight{flex:0 0 auto;}
  .btn{
    border-radius:999px;
    border:1px solid var(--blue);
    background:var(--blue);
    color:#fff;
    padding:7px 14px;
    font-size:13px;
    cursor:pointer;
    white-space:nowrap;
  }
  .btn-secondary{
    background:#fff;
    color:var(--blue);
  }
  .btn-danger{
    background:var(--danger);
    border-color:var(--danger);
  }
  .btn:disabled{
    opacity:.6;
    cursor:default;
  }
  .right{text-align:right;}
  .stack{display:flex;flex-direction:column;gap:6px;}
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:13px;
  }
  th,td{
    padding:6px 4px;
    border-bottom:1px solid #eee;
    vertical-align:top;
  }
  thead th{
    border-bottom:1px solid #ddd;
    font-weight:600;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.03em;
    color:var(--muted);
  }
  tfoot th{
    border-top:1px solid #ddd;
    border-bottom:none;
    font-weight:600;
  }
  .linkish{
    border:none;
    background:none;
    color:var(--blue);
    padding:0;
    font-size:12px;
    text-decoration:underline;
    cursor:pointer;
  }
  .tiny{font-size:11px;}
  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-bottom:4px;
  }
  .chip{
    border-radius:999px;
    padding:4px 9px;
    background:#fff;
    border:1px solid var(--border);
    font-size:11px;
    color:var(--muted);
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .chip strong{color:var(--text);font-weight:500;}
  .badge{
    display:inline-flex;
    align-items:center;
    gap:5px;
    font-size:11px;
    padding:3px 7px;
    border-radius:999px;
    background:#fff;
    border:1px solid var(--border);
    color:var(--muted);
  }
  .badge-dot{width:5px;height:5px;border-radius:999px;background:var(--blue);}
  .results-summary{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:flex-end;
    justify-content:space-between;
  }
  .results-main{
    font-size:16px;
    font-weight:600;
  }
  .results-sub{font-size:13px;color:var(--muted);}
  .result-note{margin-top:6px;font-size:12px;color:var(--muted);}
  .pill-soft{
    background:var(--accent);
    border-color:transparent;
    color:var(--blue);
  }
  .inline-num{font-variant-numeric:tabular-nums;}
  .header-eyebrow{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--muted);
    margin-bottom:3px;
  }
  #internalHeader{
    background:#fff6e5;
    border:1px solid #f0d39c;
    padding:6px 8px;
    border-radius:6px;
    font-size:11px;
    margin-bottom:10px;
  }
  #internalHeader strong{color:#8a5300;}
  @media (max-width:700px){
    .grid-2,.grid-3{grid-template-columns:1fr;}
    .controls-inline{flex-direction:column;align-items:stretch;}
    .controls-inline > .tight{align-self:flex-start;}
  }
</style>
</head>
<body>
<main>
  <div id="internalHeader">
    <strong>Builder note:</strong> This version is wired for CSV-based national averages only (no live Kroger pricing).
  </div>

  <header style="margin-bottom:18px;">
    <div class="header-eyebrow">Eatonomics tools</div>
    <h1>Recipe Cost Estimator</h1>
    <p class="tagline">
      Enter a recipe and get a ballpark ingredient-by-ingredient cost, based on national-average grocery prices.
      Adjust servings or swap ingredients to see how your total shifts.
    </p>
  </header>

  <section class="card" aria-label="recipe basics">
    <div class="card-header">
      <div class="card-title">1. Describe your recipe</div>
      <span class="pill"><span class="pill-dot"></span>Step 1 of 3</span>
    </div>
    <div class="grid grid-2">
      <div>
        <label for="recipeName">Recipe name (optional)</label>
        <input id="recipeName" type="text" placeholder="E.g., Weeknight baked ziti">
      </div>
      <div>
        <label for="servingsInput">How many servings does this recipe make?</label>
        <input id="servingsInput" type="number" min="1" step="1" value="4">
        <div class="muted tiny">We’ll use this to show an approximate per-serving cost.</div>
      </div>
    </div>
  </section>

  <section class="card" aria-label="ingredients and quantities">
    <div class="card-header">
      <div class="card-title">2. Add your ingredients</div>
      <span class="pill"><span class="pill-dot"></span>Step 2 of 3</span>
    </div>

    <div class="stack">
      <div class="chips" id="chips"></div>

      <div class="controls-inline">
        <div>
          <label for="ingInput">Ingredient</label>
          <input id="ingInput" list="ingList" type="text" placeholder="E.g., All-purpose flour">
          <datalist id="ingList"></datalist>
        </div>
        <div style="max-width:120px;">
          <label for="qtyInput">Qty</label>
          <input id="qtyInput" type="number" min="0" step="0.01" placeholder="1">
        </div>
        <div style="max-width:160px;">
          <label for="unitInput">Unit</label>
          <input id="unitInput" list="unitList" type="text" placeholder="cup, tbsp, oz, lb, each">
          <datalist id="unitList"></datalist>
        </div>
        <div class="tight" style="margin-top:18px;">
          <button class="btn" id="addBtn">Add ingredient</button>
        </div>
      </div>
    </div>

    <table aria-label="recipe items">
      <thead>
        <tr>
          <th>Ingredient</th>
          <th class="right">Qty</th>
          <th>Unit</th>
          <th class="right">Line cost</th>
          <th>Don’t have on hand</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <th colspan="3" class="right">Total</th>
          <th class="right" id="totalCell">$0.00</th>
          <th></th>
          <th></th>
        </tr>
      </tfoot>
    </table>

    <div class="controls-inline" style="margin-top:10px;">
      <button class="btn-secondary btn tiny" id="resetAll">Reset all</button>
    </div>
    <div class="stack" style="margin-top:10px;">
      <div class="muted tiny">
        National average ingredient costs are estimates and will not match your local store prices exactly.
        You can override any ingredient if you know what you paid.
      </div>
    </div>
  </section>

  <section class="card" aria-label="estimated results">
    <div class="card-header">
      <div class="card-title">3. Estimated cost</div>
      <span class="pill"><span class="pill-dot"></span>Step 3 of 3</span>
    </div>

    <div class="results-summary">
      <div>
        <div class="results-main">
          Approximate recipe cost:
          <span class="inline-num" id="totalVal">$0.00</span>
        </div>
        <div class="results-sub" id="perServing" style="display:none;"></div>
        <div class="result-note">
          Totals reflect rough national-average grocery prices and assume typical package sizes.
        </div>
      </div>
      <div>
        <span class="badge">
          <span class="badge-dot"></span>
          Estimates only – your store prices will vary.
        </span>
      </div>
    </div>
  </section>
</main>

<script>
(async function(){
  const tbody = document.getElementById("tbody");
  const totalCell = document.getElementById("totalCell");
  const totalVal = document.getElementById("totalVal");
  const ingInput = document.getElementById("ingInput");
  const qtyInput = document.getElementById("qtyInput");
  const unitInput = document.getElementById("unitInput");
  const servingsInput = document.getElementById("servingsInput");
  const chipsEl = document.getElementById("chips");
  const perServingEl = document.getElementById("perServing");
  const ingList = document.getElementById("ingList");
  const unitList = document.getElementById("unitList");

  const UNIT_LABELS = {
    "cup":"cup",
    "cups":"cup",
    "tbsp":"tbsp",
    "tablespoon":"tbsp",
    "tablespoons":"tbsp",
    "tsp":"tsp",
    "teaspoon":"tsp",
    "teaspoons":"tsp",
    "oz":"oz",
    "ounce":"oz",
    "ounces":"oz",
    "lb":"lb",
    "pound":"lb",
    "pounds":"lb",
    "g":"g",
    "gram":"g",
    "grams":"g",
    "ml":"ml",
    "milliliter":"ml",
    "milliliters":"ml",
    "l":"l",
    "liter":"l",
    "liters":"l",
    "each":"each",
    "ea":"each",
    "ct":"each"
  };

  const ALL_UNITS = [
    "cup","tbsp","tsp","oz","lb","g","ml","l","each"
  ];

  function normalizeUnit(u){
    if(!u) return "";
    return (u||"").toString().trim().toLowerCase();
  }

  function fmt(n){
    if(!isFinite(n)) return "$0.00";
    return "$" + n.toFixed(2);
  }

  const DATA = {};
  let rows = [];

  function seedIng(){
    ingList.innerHTML = "";
    Object.keys(DATA).sort().forEach(k=>{
      const item = DATA[k];
      if(!item) return;
      const o = document.createElement("option");
      o.value = item.label || k;
      o.label = item.label || k;
      o.dataset.key = k;
      ingList.appendChild(o);
    });
  }

  function seedUnits(){
    unitList.innerHTML="";
    ALL_UNITS.forEach(u=>{
      const o=document.createElement("option");
      o.value = u;
      o.label = u;
      unitList.appendChild(o);
    });
  }

  function addChip(text){
    const span=document.createElement("span");
    span.className="chip";
    span.innerHTML=`<strong>${text}</strong>`;
    chipsEl.appendChild(span);
  }

  addChip("Use national-average ingredient costs");
  addChip("Override any ingredient if you know your store price");

  function convertBetweenUnits(value, fromUnit, toUnit, item){
    fromUnit = normalizeUnit(fromUnit);
    toUnit   = normalizeUnit(toUnit);
    if(!isFinite(value)) return null;
    const v = Number(value);

    if(fromUnit===toUnit) return v;

    const density = item && item.cupOz ? item.cupOz : null;

    function cupsToBase(cups){
      if(toUnit==="oz" && density){
        return cups * density;
      }
      if(toUnit==="lb" && density){
        return (cups * density)/16;
      }
      if(toUnit==="g" && density){
        return cups * density * 28.3495;
      }
      if(toUnit==="ml"){
        return cups * 240;
      }
      return null;
    }

    function baseToCups(val){
      if(fromUnit==="oz" && density){
        return val / density;
      }
      if(fromUnit==="lb" && density){
        return (val*16)/density;
      }
      if(fromUnit==="g" && density){
        return val / (density*28.3495);
      }
      if(fromUnit==="ml"){
        return val/240;
      }
      return null;
    }

    if(fromUnit==="cup" && density){
      const base = cupsToBase(v);
      return base;
    }
    if(toUnit==="cup" && density){
      const cups = baseToCups(v);
      return cups;
    }

    const toOz = u=>{
      if(u==="oz") return 1;
      if(u==="lb") return 16;
      if(u==="g")  return 1/28.3495;
      if(u==="ml") return 1/29.5735;
      if(u==="l")  return 33.814;
      if(u==="cup")return 8;
      if(u==="tbsp")return 0.5;
      if(u==="tsp") return 1/6;
      return null;
    };

    const fromFactor=toOz(fromUnit);
    const toFactor  =toOz(toUnit);
    if(fromFactor && toFactor){
      const ozVal=v*fromFactor;
      return ozVal/toFactor;
    }

    if(fromUnit==="each" && toUnit!=="each"){
      return null;
    }
    if(toUnit==="each" && fromUnit!=="each"){
      return null;
    }

    if(fromUnit==="each" && toUnit==="each"){
      return v;
    }

    return null;
  }

  function resolveQtyUnit(item, qtyRaw, unitRaw){
    const qty = Number(qtyRaw);
    if(!isFinite(qty) || qty<=0){
      return {qtyDisplay:"", unitDisplay:"", baseQty:0};
    }
    const unitDisplay = UNIT_LABELS[unitRaw] || unitRaw || "";
    let baseQty = qty;

    const baseUnit = item.baseUnit || "each";
    if(unitRaw && baseUnit && unitRaw!==baseUnit){
      const converted = convertBetweenUnits(qty, unitRaw, baseUnit, item);
      if(converted && converted>0){
        baseQty = converted;
      }
    }

    return {qtyDisplay:qtyRaw, unitDisplay, baseQty};
  }

  function render(){
    tbody.innerHTML=""; let total=0;

    rows.forEach((r,i)=>{
      const item = DATA[r.key];
      let lineCost = 0;

      if(item){
        let pricePerBase = item.pricePerBase || 0;

        // If the user provided a cost for the full item, convert it to a per-base-unit cost
        if (r.userItemCost != null && item.packSize && item.packUnit) {
          const packInBase = convertBetweenUnits(item.packSize, item.packUnit, item.baseUnit, item);
          if (packInBase && packInBase > 0) {
            pricePerBase = Number(r.userItemCost) / packInBase;
          }
        }

        const incremental = r.baseQty * pricePerBase;

        if(r.needBuy && item.packSize && item.packUnit){
          const packInBase = convertBetweenUnits(item.packSize, item.packUnit, item.baseUnit, item);
          if(packInBase && packInBase > 0){
            const packs = Math.ceil(r.baseQty / packInBase);
            const purchasedBaseQty = packs * packInBase;
            lineCost = purchasedBaseQty * pricePerBase;
          } else {
            lineCost = incremental;
          }
        } else {
          lineCost = incremental;
        }
      }

      total += lineCost;

      const tr=document.createElement("tr");
      tr.innerHTML=`
      <td>${r.label}</td>
      <td class="right">${r.qtyDisplay}</td>
      <td>${r.unitDisplay}</td>
      <td class="right">
        ${fmt(lineCost)}
        <div class="tiny muted">
          <label>
            Your item cost (optional)
            <input type="number" min="0" step="0.01" class="customCost" data-i="${i}" value="${r.userItemCost != null ? r.userItemCost : ''}" title="Enter the cost of the full item you purchased, like a whole bell pepper or full bag of flour. We will calculate the portion cost for this recipe.">
          </label>
        </div>
      </td>
      <td>
        <label class="tiny" style="display:flex;align-items:center;gap:4px;">
          <input type="checkbox" class="needBuyChk" data-i="${i}" ${r.needBuy ? "checked" : ""}>
          <span>Don’t have</span>
        </label>
      </td>
      <td><button class="linkish tiny" data-i="${i}">remove</button></td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-i]").forEach(b=>{
      b.addEventListener("click",e=>{
        rows.splice(Number(e.target.getAttribute("data-i")),1);
        render();
      });
    });

    // per-row "don't have" checkboxes
    tbody.querySelectorAll(".needBuyChk").forEach(cb=>{
      cb.addEventListener("change",e=>{
        const idx = Number(e.target.getAttribute("data-i"));
        if (!isNaN(idx) && rows[idx]){
          rows[idx].needBuy = e.target.checked;
          render();
        }
      });
    });

    // per-row custom item cost inputs
    tbody.querySelectorAll(".customCost").forEach(inp=>{
      inp.addEventListener("input", e=>{
        const idx = Number(e.target.getAttribute("data-i"));
        if (!isNaN(idx) && rows[idx]) {
          const v = Number(e.target.value);
          if (Number.isFinite(v) && v > 0) {
            rows[idx].userItemCost = v;
          } else {
            rows[idx].userItemCost = null;
          }
          render();
        }
      });
    });

    totalCell.textContent = fmt(total);
    totalVal.textContent = fmt(total);
    const s=Number(servingsInput.value);
    if(isFinite(s)&&s>0){
      perServingEl.style.display="";
      perServingEl.textContent=`Per-serving: ${fmt(total/s)}`;
    } else {
      perServingEl.style.display="none";
    }
  }

  document.getElementById("addBtn").addEventListener("click", ()=>{
    const nameRaw = (ingInput.value || "").trim();
    const qtyRaw  = (qtyInput.value  || "").trim();
    const unitRaw = normalizeUnit(unitInput.value || "");
    if(!nameRaw || !qtyRaw || !unitRaw) return;

    const lower = nameRaw.toLowerCase();
    let key = null;
    let item = null;

    if(DATA[lower]){
      key = lower;
      item = DATA[lower];
    } else {
      const matchKey = Object.keys(DATA).find(k=>(DATA[k].label||k).toLowerCase()===lower);
      if(matchKey){
        key = matchKey;
        item = DATA[matchKey];
      }
    }

    if(!item){
      key = lower;
      item = DATA[key] = {
        label: nameRaw,
        baseUnit: unitRaw || "each",
        pricePerBase: 0,
        conversions:{}
      };
    }

    const resolved = resolveQtyUnit(item, qtyRaw, unitRaw);
    const baseQty = resolved.baseQty || 0;
    if(baseQty<=0) return;

    rows.push({
      key,
      label: item.label || nameRaw,
      qtyDisplay: resolved.qtyDisplay || qtyRaw,
      unitDisplay: resolved.unitDisplay || (UNIT_LABELS[unitRaw] || unitRaw),
      baseQty,
      needBuy: false,
      userItemCost: null
    });

    ingInput.value = "";
    qtyInput.value = "";
    unitInput.value = "";
    render();
  });

  document.getElementById("resetAll").addEventListener("click", ()=>{
    rows = [];
    render();
  });

  servingsInput.addEventListener("input", render);

  async function tryMergeExternal(){
    try{
      const rj = await fetch("./data/ingredients.json", {cache:"no-store"});
      if(rj.ok){
        const extra = await rj.json();
        Object.assign(DATA, extra);
      }
    }catch{}
    try{
      const rc = await fetch("./data/ingredients.csv", {cache:"no-store"});
      if(rc.ok){
        const csv = await rc.text();
        parseCsv(csv);
      }
    }catch{}
  }

  function parseCsv(csv){
    const lines = csv.split(/\r?\n/).filter(l=>l.trim().length>0);
    if(lines.length<2) return;
    const headers = lines[0].split(",").map(h=>h.trim().toLowerCase());
    const idx = {
      key: headers.indexOf("key"),
      label: headers.indexOf("label"),
      baseUnit: headers.indexOf("baseunit"),
      pricePerBase: headers.indexOf("priceperbase"),
      cupOz: headers.indexOf("cupoz"),
      packSize: headers.indexOf("packsize"),
      packUnit: headers.indexOf("packunit"),
    };
    for(const line of lines.slice(1)){
      const parts = line.split(",");
      const key = (parts[idx.key]||"").trim().toLowerCase();
      if(!key) continue;
      const label = (parts[idx.label]||"").trim() || key;
      const baseUnit = (parts[idx.baseUnit]||"").trim() || "each";
      const pricePerBase = Number((parts[idx.pricePerBase]||"0").trim()) || 0;
      const cupOz = Number((parts[idx.cupOz]||"").trim()) || undefined;
      const packSize = Number((parts[idx.packSize]||"").trim()) || undefined;
      const packUnit = (parts[idx.packUnit]||"").trim() || undefined;
      DATA[key] = DATA[key] || {label, baseUnit, pricePerBase, conversions:{}};
      DATA[key].label = label;
      DATA[key].baseUnit = baseUnit;
      DATA[key].pricePerBase = pricePerBase;
      if(cupOz){ DATA[key].cupOz = cupOz; }
      if(packSize && packUnit){ DATA[key].packSize = packSize; DATA[key].packUnit = packUnit; }
    }
  }

  await tryMergeExternal();
  seedIng();
  seedUnits();
  render();
})();
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Recipe Cost Estimator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Estimate total and per-serving recipe cost using common kitchen units like cups, tablespoons, ounces, pounds, sticks, and cans." />

  <style>
    :root{
      --blue:#1f66d8;
      --line:#e1e4eb;
      --text:#222;
      --muted:#555;
      --bg:#fafbff;
      --pill:#f2f4fb;
      --danger:#b3261e;
    }
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;}
    body{margin:0;padding:0;background:#fff;color:var(--text);}
    .page{max-width:960px;margin:0 auto;padding:24px 16px 48px;}
    h1{font-weight:600;font-size:30px;margin:0 0 4px;}
    .lede{margin:0 0 24px;font-size:14px;color:var(--muted);max-width:700px;}
    .card{border:1px solid var(--line);border-radius:12px;padding:24px 24px 28px;background:#fff;box-shadow:0 8px 20px rgba(0,0,0,0.03);}
    .layout{display:flex;gap:32px;align-items:flex-start;}
    @media(max-width:840px){
      .layout{flex-direction:column;}
    }
    .step-col{flex:1 1 0;}
    .side-col{flex:0 0 290px;}
    .step-header{display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;}
    .step-num{font-size:40px;font-weight:200;color:#e2e6f2;line-height:1;}
    .step-title{font-weight:600;margin-bottom:2px;}
    .step-sub{font-size:13px;color:var(--muted);}
    label{display:block;font-size:13px;font-weight:500;margin-bottom:4px;}
    input[type="text"],input[type="number"],select{
      width:100%;border:1px solid var(--line);border-radius:8px;padding:8px 10px;
      font-size:14px;outline:none;transition:border-color .15s,box-shadow .15s;
    }
    input[type="text"]:focus,input[type="number"]:focus,select:focus{
      border-color:var(--blue);box-shadow:0 0 0 1px rgba(31,102,216,0.15);
    }
    .row{display:flex;gap:12px;}
    .row + .row{margin-top:8px;}
    .row > div{flex:1;}
    .row > .shrink{flex:0 0 120px;}
    .row > .xs{flex:0 0 72px;}
    button{
      border-radius:999px;border:1px solid var(--blue);background:var(--blue);
      color:#fff;font-size:14px;padding:8px 16px;cursor:pointer;
      font-weight:500;transition:filter .15s,border-color .15s,background .15s,color .15s;
    }
    button:hover{filter:brightness(.95);}
    button:disabled{opacity:.5;cursor:default;}
    .btn-ghost{background:#fff;color:var(--blue);border-color:var(--blue);}
    .btn-plain{background:none;border:none;color:var(--blue);padding:0 4px;font-size:13px;}
    .btn-plain:hover{text-decoration:underline;filter:none;}
    .tiny{font-size:12px;}
    .muted{color:var(--muted);}
    table{width:100%;border-collapse:collapse;margin-top:12px;}
    th,td{padding:4px 0;font-size:13px;text-align:left;}
    th{border-bottom:1px solid var(--line);font-weight:500;color:var(--muted);}
    td{border-bottom:1px solid #f2f3f7;}
    td.qty,td.unit,td.money{text-align:right;}
    .total-row{font-weight:600;border-top:2px solid var(--line);}
    .total-row.flash{background:#fff9e6;transition:background .5s;}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);border-radius:999px;padding:4px 9px;font-size:11px;color:var(--muted);}
    .pill strong{color:var(--text);font-weight:600;}
    .pill-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
    .field-note{font-size:12px;color:var(--muted);margin-top:4px;}
    .error{color:var(--danger);font-size:12px;margin-top:4px;}
    .badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:500;}
    .badge-strong{background:var(--blue);color:#fff;}
    .badge-soft{background:var(--pill);color:var(--muted);}
    .chip-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;}
    .chip{font-size:11px;color:var(--muted);}
    .chip span{font-weight:600;color:var(--text);}
    .finder-card{border-radius:12px;border:1px dashed var(--line);padding:16px;margin-top:20px;background:var(--bg);}
    .finder-title{font-size:13px;font-weight:600;margin-bottom:8px;}
    .finder-row{display:flex;gap:8px;flex-wrap:wrap;}
    .finder-row > *{flex:1 1 0;}
    .btn-finder-main{width:100%;}
    .btn-finder-sub{flex:1 1 0;background:#fff;color:var(--blue);}
    .disclaimer{margin-top:16px;font-size:11px;color:var(--muted);line-height:1.45;}
    .results-number{font-size:32px;font-weight:600;margin-bottom:2px;}
    .results-label{font-size:13px;color:var(--muted);}
    .kicker{font-size:11px;color:var(--muted);margin-top:4px;}
    .tagline{font-size:11px;color:var(--muted);margin-top:6px;}
    .inline-link{color:var(--blue);text-decoration:none;}
    .inline-link:hover{text-decoration:underline;}
    .pill-btn{border-radius:10px;padding:6px 10px;font-size:13px;}
    .btn-region{border-radius:8px;font-size:12px;padding:6px 10px;}
    .controls-inline{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:8px;}
    .controls-inline input{flex:1 1 0;}
    .controls-inline button{flex:0 0 auto;}
  </style>
</head>
<body>
<div class="page">

  <div id="internalHeader" class="tiny muted" style="margin-bottom:8px;">
    Internal preview &middot; not for public release
  </div>

  <h1>Recipe Cost Estimator</h1>
  <p class="lede">
    Enter ingredients with normal kitchen units (cup, tablespoon, teaspoon, ounce, pound, stick, each, gram, kilogram, milliliter, liter, quart, pint, can). We will total the recipe and, if you like, show per-serving cost.
  </p>

  <div class="card">
    <div class="layout">

      <!-- LEFT COLUMN: inputs -->
      <div class="step-col">
        <!-- Step 1: ingredients -->
        <div class="step-header">
          <div class="step-num">1</div>
          <div>
            <div class="step-title">Enter your ingredients below</div>
            <div class="step-sub">Use the ingredient search and common kitchen units.</div>
          </div>
        </div>

        <div>
          <div class="row">
            <div>
              <label for="ingredientInput">Ingredient (type to search)</label>
              <input id="ingredientInput" type="text" autocomplete="off" />
              <div id="ingHelp" class="field-note">Start typing to see suggestions from the ingredient list.</div>
              <div id="ingError" class="error" style="display:none;"></div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="xs">
              <label for="qtyInput">Quantity</label>
              <input id="qtyInput" type="text" value="1" />
            </div>
            <div class="shrink">
              <label for="unitInput">Unit (type to filter)</label>
              <input id="unitInput" type="text" value="cup" />
            </div>
            <div class="shrink" style="align-self:flex-end;">
              <button id="addBtn">Add ingredient</button>
            </div>
          </div>

          <div class="field-note" style="margin-top:12px;">
            Fractions like "1/2" or "1 1/2" are accepted.
            Select "each" when counting whole ingredients (for example 3 eggs, 5 onions).
            For cans, enter quantity like 2 x 28 oz with unit "can" (defaults to 1 x 15 oz if size is omitted). The "x" can be typed as "x".
          </div>

          <div style="margin-top:16px;">
            <table>
              <thead>
              <tr>
                <th>Ingredient</th>
                <th class="qty">Qty</th>
                <th class="unit">Unit</th>
                <th class="money">Line cost</th>
              </tr>
              </thead>
              <tbody id="lineItems"></tbody>
              <tfoot>
              <tr id="totalRow" class="total-row">
                <td>Total</td>
                <td></td>
                <td></td>
                <td class="money" id="totalCell">$0.00</td>
              </tr>
              </tfoot>
            </table>
            <div style="margin-top:6px;">
              <button id="resetAll" class="btn-plain">Reset all</button>
            </div>
          </div>
        </div>

        <!-- Step 2: servings -->
        <div style="margin-top:32px;">
          <div class="step-header">
            <div class="step-num">2</div>
            <div>
              <div class="step-title">Optional &mdash; Per-serving estimate</div>
              <div class="step-sub">Enter how many servings this recipe makes.</div>
            </div>
          </div>

          <div class="row">
            <div class="shrink" style="max-width:220px;">
              <label for="servingsInput">Servings (optional)</label>
              <input id="servingsInput" type="number" min="1" step="1" placeholder="e.g., 4" />
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: results + regional pricing -->
      <div class="side-col">
        <div class="step-header">
          <div class="step-num">3</div>
          <div>
            <div class="step-title">Results</div>
            <div class="step-sub">Total cost and optional per-serving estimate.</div>
          </div>
        </div>

        <div>
          <div class="results-number" id="resultsTotal">$0.00</div>
          <div class="results-label" id="resultsLabel">Total recipe cost</div>
          <div class="kicker" id="perServingKicker"></div>

          <div class="pill-row" id="summaryPills"></div>

          <div class="field-note" style="margin-top:10px;" id="methodNote">
            Totals include basic unit conversions and rounding to practical package sizes.
          </div>

          <hr style="margin:20px 0;border:none;border-top:1px solid var(--line);" />

          <!-- Regional pricing controls (ZIP-based, with optional store dropdown) -->
          <div>
            <div class="tiny muted" style="margin-bottom:6px;">
              Optional &mdash; For a more accurate estimate, use my location.
            </div>
            <button id="locBtn" class="btn-ghost" style="margin-bottom:10px;">Use my location</button>

            <div class="tiny muted" style="margin-top:6px;">Or enter ZIP and choose a nearby store.</div>
            <div class="controls-inline" style="margin-top:6px;">
              <input id="zipInput" type="text" placeholder="ZIP" />
              <button id="findStoresBtn" class="pill-btn">Find stores</button>
            </div>

            <div class="field-note" id="storeError" style="display:none;margin-top:4px;"></div>

            <div style="margin-top:8px;">
              <select id="storeSelect">
                <option value="">No store selected</option>
              </select>
            </div>

            <div style="margin-top:10px;">
              <button id="storePricesBtn" class="btn-ghost" disabled>Use store prices</button>
            </div>

            <div style="margin-top:10px;font-size:11px;">
              <span id="regionBadge" class="badge badge-soft" style="display:none;">Regional</span>
              <span id="regionNote" class="tiny muted">Using national grocery averages.</span>
              <div id="priceNote" class="tiny muted" style="margin-top:4px;">
                Prices use national grocery averages. Actual costs may vary by store and region.
              </div>
            </div>
          </div>

          <div class="finder-card">
            <div class="finder-title">Take this list to the store</div>
            <div class="finder-row">
              <button class="btn-finder-main">Copy ingredients and totals</button>
              <button class="btn-finder-sub">Email to myself</button>
              <button class="btn-finder-sub">Download as text</button>
            </div>
            <div class="disclaimer">
              Use for planning only. Prices are estimates based on typical grocery costs and may not match your local store. Always check in-store prices and promotions.
            </div>
          </div>
        </div>

      </div><!-- /side-col -->

    </div><!-- /layout -->
  </div><!-- /card -->

  <div class="disclaimer" style="margin-top:18px;">
    This tool is for planning and education only. Estimates are based on typical grocery prices and unit conversions. Results depend on the information you enter and may not reflect actual store prices or promotions.
  </div>

</div><!-- /page -->

<script>
  // === Globals ===
  let INGREDIENT_DATA = {};
  let INGREDIENT_KEYS = [];
  let rows = [];
  let servings = null;
  let REGION = { name: "National", factor: 1.00 };
  let useStorePricing = false;
  let STORE_ING = {};
  let STORE_LIST = [];
  let ingredientsLoaded = false;

  const ingredientInput = document.getElementById("ingredientInput");
  const qtyInput        = document.getElementById("qtyInput");
  const unitInput       = document.getElementById("unitInput");
  const addBtn          = document.getElementById("addBtn");
  const lineItemsBody   = document.getElementById("lineItems");
  const totalCell       = document.getElementById("totalCell");
  const totalRow        = document.getElementById("totalRow");
  const servingsInput   = document.getElementById("servingsInput");
  const resetAllBtn     = document.getElementById("resetAll");
  const ingError        = document.getElementById("ingError");
  const ingHelp         = document.getElementById("ingHelp");

  const resultsTotal    = document.getElementById("resultsTotal");
  const resultsLabel    = document.getElementById("resultsLabel");
  const perServingKicker= document.getElementById("perServingKicker");
  const summaryPills    = document.getElementById("summaryPills");
  const methodNote      = document.getElementById("methodNote");

  const locBtn          = document.getElementById("locBtn");
  const zipInput        = document.getElementById("zipInput");
  const findStoresBtn   = document.getElementById("findStoresBtn");
  const storeSelect     = document.getElementById("storeSelect");
  const storePricesBtn  = document.getElementById("storePricesBtn");
  const storeError      = document.getElementById("storeError");
  const regionBadge     = document.getElementById("regionBadge");
  const regionNote      = document.getElementById("regionNote");
  const priceNote       = document.getElementById("priceNote");

  // === Utility: parse quantity, including simple fractions ===
  function parseQty(str){
    if(!str) return NaN;
    str = String(str).trim();
    if(!str) return NaN;
    if(str.includes("/")){
      const parts = str.split(" ");
      let total = 0;
      for(const p of parts){
        if(!p) continue;
        if(p.includes("/")){
          const [n,d] = p.split("/");
          const nf = parseFloat(n.replace(/[^\d.]/g,""));
          const df = parseFloat(d.replace(/[^\d.]/g,""));
          if(!isNaN(nf) && !isNaN(df) && df!==0){ total += nf/df; }
        }else{
          const v = parseFloat(p.replace(/[^\d.]/g,""));
          if(!isNaN(v)) total += v;
        }
      }
      return total;
    }
    return parseFloat(str.replace(/[^\d.]/g,""));
  }

  // === Units + conversions ===
  const UNIT_GROUPS = {
    volume: ["tsp","teaspoon","tbsp","tablespoon","fl oz","fluid ounce","cup","quart","pint","ml","milliliter","liter","l"],
    weight: ["oz","ounce","lb","pound","g","gram","kg","kilogram"],
    each:   ["each","stick","can","egg","piece","clove"],
  };

  function normalizeUnit(u){
    if(!u) return "";
    u = u.trim().toLowerCase();
    if(u === "t" || u === "tsp.") return "tsp";
    if(u === "tbsp." || u === "tbs" || u === "T") return "tbsp";
    if(u === "fl. oz" || u === "floz") return "fl oz";
    if(u === "c") return "cup";
    if(u === "pt") return "pint";
    if(u === "qt") return "quart";
    if(u === "oz.") return "oz";
    if(u === "lb." || u === "lbs") return "lb";
    if(u === "g.") return "g";
    if(u === "kg.") return "kg";
    if(u === "ml.") return "ml";
    if(u === "l.") return "l";
    if(u === "ea") return "each";
    return u;
  }

  function unitGroup(unit){
    unit = normalizeUnit(unit);
    for(const g of Object.keys(UNIT_GROUPS)){
      if(UNIT_GROUPS[g].includes(unit)) return g;
    }
    return null;
  }

  // generic cup-ounce assumptions when we do not have a food-specific density
  function genericCupOzFor(group){
    if(group === "weight") return 4.5;   // generic "cup to oz" guess for dry-ish ingredients
    if(group === "volume") return 8.0;   // cup to fl oz
    return null;
  }

  function convertToBaseQty(qty, fromUnit, baseUnit, ing){
    fromUnit = normalizeUnit(fromUnit);
    baseUnit = normalizeUnit(baseUnit);

    if(fromUnit === baseUnit) return qty;

    const gFrom = unitGroup(fromUnit);
    const gBase = unitGroup(baseUnit);

    if(gFrom === "volume" && gBase === "volume"){
      const toFlOz = {
        "tsp": 1/6,
        "teaspoon": 1/6,
        "tbsp": 0.5,
        "tablespoon":0.5,
        "fl oz":1,
        "fluid ounce":1,
        "cup":8,
        "pint":16,
        "quart":32,
        "ml": 1/29.5735,
        "milliliter":1/29.5735,
        "liter":33.814,
        "l":33.814
      };
      const fromFl = toFlOz[fromUnit];
      const baseFl = toFlOz[baseUnit];
      if(fromFl && baseFl){
        return qty * fromFl / baseFl;
      }
    }

    if(gFrom === "weight" && gBase === "weight"){
      const toOz = {
        "oz":1,
        "ounce":1,
        "lb":16,
        "pound":16,
        "g":1/28.3495,
        "gram":1/28.3495,
        "kg":35.274,
        "kilogram":35.274
      };
      const fromOz = toOz[fromUnit];
      const baseOz = toOz[baseUnit];
      if(fromOz && baseOz){
        return qty * fromOz / baseOz;
      }
    }

    // volume to weight conversion using cupOz when we have it
    if(gFrom === "volume" && gBase === "weight"){
      const cupOz = (ing && ing.cupOz) ? ing.cupOz : genericCupOzFor("weight");
      if(!cupOz) return NaN;
      const cups = convertToBaseQty(qty, fromUnit, "cup", ing);
      if(isNaN(cups)) return NaN;
      const ozTotal = cups * cupOz;
      const weightInBase = convertToBaseQty(ozTotal, "oz", baseUnit, ing);
      return weightInBase;
    }

    // weight to volume (rare; use inverse if we have cupOz)
    if(gFrom === "weight" && gBase === "volume"){
      const cupOz = (ing && ing.cupOz) ? ing.cupOz : genericCupOzFor("weight");
      if(!cupOz) return NaN;
      const ozInFrom = convertToBaseQty(qty, fromUnit, "oz", ing);
      if(isNaN(ozInFrom)) return NaN;
      const cups = ozInFrom / cupOz;
      const volInBase = convertToBaseQty(cups, "cup", baseUnit, ing);
      return volInBase;
    }

    if(gFrom === "each" && gBase === "each"){
      return qty;
    }

    return NaN;
  }

  function money(n){
    if(!isFinite(n)) return "$0.00";
    const s = n.toFixed(2);
    return "$" + s.replace(/\B(?=(\d{3})+(?!\d))/g,",");
  }

  // === Ingredient suggestions ===
  function seedIng(){
    if(!ingredientsLoaded) return;
    if(!ingredientInput) return;
    ingredientInput.setAttribute("placeholder","Start typing (e.g., flour, sugar, milk)");
  }

  function seedUnits(){
    if(!unitInput) return;
    unitInput.value = "cup";
  }

  function findIngredientMatch(query){
    if(!ingredientsLoaded) return null;
    if(!query) return null;
    const q = query.trim().toLowerCase();
    if(!q) return null;

    let exactKey = null;
    for(const k of INGREDIENT_KEYS){
      const ing = INGREDIENT_DATA[k];
      if(ing.key.toLowerCase() === q || ing.label.toLowerCase() === q){
        exactKey = k;
        break;
      }
    }
    if(exactKey) return INGREDIENT_DATA[exactKey];

    const hitKey = INGREDIENT_KEYS.find(k=>{
      const ing = INGREDIENT_DATA[k];
      return ing.label.toLowerCase().startsWith(q);
    });
    if(hitKey) return INGREDIENT_DATA[hitKey];

    return null;
  }

  function renderSuggestions(){
    if(!ingredientsLoaded) return;
    const q = ingredientInput.value.trim().toLowerCase();
    if(!q){
      ingHelp.style.display = "block";
      ingError.style.display = "none";
      return;
    }
    const matches = INGREDIENT_KEYS
      .map(k=>INGREDIENT_DATA[k])
      .filter(ing=>ing.label.toLowerCase().includes(q))
      .slice(0,8);

    if(matches.length === 0){
      ingHelp.style.display = "none";
      ingError.style.display = "block";
      ingError.textContent = "No ingredients found. Try a simpler name like 'flour' or 'milk'.";
    }else{
      ingHelp.style.display = "block";
      ingError.style.display = "none";
      const names = matches.map(m=>m.label).join(", ");
      ingHelp.textContent = "Suggestions: " + names;
    }
  }

  // === Row handling ===
  function addRow(){
    const ingName = ingredientInput.value.trim();
    const qtyStr  = qtyInput.value;
    const unitStr = unitInput.value;

    const qty = parseQty(qtyStr);
    if(isNaN(qty) || qty<=0){
      alert("Please enter a valid quantity.");
      return;
    }

    const ing = findIngredientMatch(ingName);
    if(!ing){
      alert("Please choose an ingredient from the suggestions (for example 'All-Purpose Flour').");
      return;
    }

    const unitNorm = normalizeUnit(unitStr || ing.baseUnit || "cup");

    const baseUnit = ing.baseUnit || unitNorm;
    const baseQty  = convertToBaseQty(qty, unitNorm, baseUnit, ing);

    const perBase  = ing.pricePerBase || 0;
    const lineCost = isNaN(baseQty) ? 0 : baseQty * perBase;

    rows.push({
      key: ing.key,
      label: ing.label,
      qty,
      unit: unitNorm,
      baseQty,
      baseUnit,
      lineCost
    });

    ingredientInput.value = "";
    qtyInput.value = "1";
    unitInput.value = unitNorm;
    render();
  }

  function removeRow(idx){
    rows.splice(idx,1);
    render();
  }

  function computeTotal(){
    let total = 0;
    for(const r of rows){
      const ing = INGREDIENT_DATA[r.key] || {};
      const perBase = (useStorePricing ? (STORE_ING[r.key]?.pricePerBase ?? ing.pricePerBase) : ing.pricePerBase) || 0;
      const baseQty = isNaN(r.baseQty) ? 0 : r.baseQty;
      total += baseQty * perBase;
    }
    if(REGION && REGION.factor){
      total = total * REGION.factor;
    }
    return total;
  }

  function render(){
    lineItemsBody.innerHTML = "";
    rows.forEach((r,idx)=>{
      const tr = document.createElement("tr");

      const tdName  = document.createElement("td");
      const tdQty   = document.createElement("td");
      const tdUnit  = document.createElement("td");
      const tdMoney = document.createElement("td");

      tdName.textContent = r.label;
      tdQty.textContent  = r.qty;
      tdQty.className    = "qty";
      tdUnit.textContent = r.unit;
      tdUnit.className   = "unit";
      tdMoney.textContent= money(r.lineCost);
      tdMoney.className  = "money";

      const tdRemove = document.createElement("td");
      tdRemove.className = "money";
      const rmBtn = document.createElement("button");
      rmBtn.textContent = "x";
      rmBtn.className = "btn-plain";
      rmBtn.style.fontSize = "12px";
      rmBtn.addEventListener("click", ()=>removeRow(idx));
      tdRemove.appendChild(rmBtn);

      tr.appendChild(tdName);
      tr.appendChild(tdQty);
      tr.appendChild(tdUnit);
      tr.appendChild(tdMoney);

      lineItemsBody.appendChild(tr);
    });

    const total = computeTotal();
    totalCell.textContent = money(total);
    resultsTotal.textContent = money(total);

    if(rows.length === 0){
      resultsLabel.textContent = "Total recipe cost";
      perServingKicker.textContent = "";
    }else{
      if(servings && servings>0){
        const perServ = total / servings;
        resultsLabel.textContent = "Total recipe cost";
        perServingKicker.textContent = "About " + money(perServ) + " per serving.";
      }else{
        resultsLabel.textContent = "Total recipe cost";
        perServingKicker.textContent = "";
      }
    }

    summaryPills.innerHTML = "";
    if(rows.length){
      const pill1 = document.createElement("div");
      pill1.className="pill";
      pill1.innerHTML = "<strong>"+rows.length+"</strong> ingredients";
      summaryPills.appendChild(pill1);

      if(servings && servings>0){
        const pill2 = document.createElement("div");
        pill2.className="pill";
        pill2.innerHTML = "<strong>"+servings+"</strong> servings";
        summaryPills.appendChild(pill2);
      }

      const pill3 = document.createElement("div");
      pill3.className="pill";
      pill3.innerHTML = "<strong>"+REGION.name+"</strong> pricing";
      summaryPills.appendChild(pill3);

      if(useStorePricing){
        const pill4 = document.createElement("div");
        pill4.className="pill";
        pill4.innerHTML = "<strong>Store data</strong> applied";
        summaryPills.appendChild(pill4);
      }
    }
  }

  // === Event wiring (core) ===
  addBtn.addEventListener("click", addRow);
  ingredientInput.addEventListener("input", renderSuggestions);
  ingredientInput.addEventListener("blur", ()=>setTimeout(()=>{ ingHelp.style.display="none"; ingError.style.display="none"; },200));
  qtyInput.addEventListener("keyup", e=>{ if(e.key === "Enter") addRow(); });
  unitInput.addEventListener("keyup", e=>{ if(e.key === "Enter") addRow(); });

  servingsInput.addEventListener("input", ()=>{
    const v = parseInt(servingsInput.value,10);
    if(isNaN(v) || v<=0){ servings = null; }
    else{ servings = v; }
    render();
  });

  resetAllBtn.addEventListener("click", ()=>{
    rows = [];
    servingsInput.value = "";
    servings = null;
    REGION = { name:"National", factor:1.00 };
    useStorePricing = false;
    regionBadge.style.display="none";
    regionNote.textContent = "Using national grocery averages.";
    priceNote.textContent = "Prices use national grocery averages. Actual costs may vary by store and region.";
    render();
  });

  // === Region via geolocation (for now; safe-guarded) ===
  if(locBtn && navigator.geolocation){
    locBtn.addEventListener("click", ()=>{
      navigator.geolocation.getCurrentPosition(pos=>{
        const { latitude:lat, longitude:lon } = pos.coords;
        const REGION_FACTORS = [
          { name:"Northeast", factor:1.06, box:[[-82,36],[-66,47]]},
          { name:"Southeast", factor:0.96, box:[[-91,24],[-75,36]]},
          { name:"Midwest",   factor:0.98, box:[[-104,36],[-82,49]]},
          { name:"Southwest", factor:1.00, box:[[-115,25],[-95,37]]},
          { name:"West",      factor:1.08, box:[[-125,32],[-114,49]]}
        ];
        const hit = REGION_FACTORS.find(r=>{
          const [[minLon,minLat],[maxLon,maxLat]] = [r.box[0], r.box[1]];
          return lon>=minLon && lon<=maxLon && lat>=minLat && lat<=maxLat;
        });
        if(hit){
          REGION = { name:hit.name, factor:hit.factor };
          regionNote.textContent = `Using ${hit.name} regional average`;
          regionBadge.style.display = "inline-block";
          regionBadge.textContent = "Regional";
          priceNote.textContent = `Prices adjusted using ${hit.name} regional averages.`;
        }else{
          REGION = { name:"National", factor:1.00 };
          regionNote.textContent = "Using national average";
          regionBadge.style.display = "none";
          priceNote.textContent = "Prices use national grocery averages. Actual costs may vary by store and region.";
        }
        totalRow.classList.remove("flash"); void totalRow.offsetWidth; totalRow.classList.add("flash");
        render();
      }, ()=>{
        regionNote.textContent = "Location permission declined";
      }, { timeout:8000 });
    });
  }

  // === Kroger-style external data wiring (stub for now) ===
  async function tryMergeExternal(){
    try{
      const rc = await fetch("./data/ingredients.csv", {cache:"no-store"});
      if(!rc.ok) return;
      const text = await rc.text();

      const lines = text.split(/\r?\n/).filter(l=>l.trim());
      if(lines.length < 2) return;

      const hdr = lines[0].split(",").map(h=>h.trim().toLowerCase());

      const idx = {
        key:       hdr.indexOf("key"),
        label:     hdr.indexOf("label"),
        baseUnit:  hdr.indexOf("baseunit"),
        pricePerBase: hdr.indexOf("priceperbase"),
        cupOz:     hdr.indexOf("cupoz"),
        packSize:  hdr.indexOf("packsize"),
        packUnit:  hdr.indexOf("packunit")
      };

      lines.slice(1).forEach(row=>{
        const cols = row.split(",").map(c=>c.trim());
        if(!cols.length) return;

        const key   = cols[idx.key] || "";
        if(!key) return;

        const label = cols[idx.label] || key.replace(/_/g," ").replace(/\s+/g," ").replace(/\b\w/g,ch=>ch.toUpperCase());
        const baseUnit = cols[idx.baseUnit] || "lb";
        const pricePerBase = parseFloat(cols[idx.pricePerBase] || "0") || 0;
        const cupOz  = parseFloat(cols[idx.cupOz] || "0") || 0;
        const packSize = parseFloat(cols[idx.packSize] || "0") || 0;
        const packUnit = cols[idx.packUnit] || "";

        INGREDIENT_DATA[key] = {
          key,
          label,
          baseUnit,
          pricePerBase,
          cupOz: cupOz || null,
          packSize: packSize || null,
          packUnit: packUnit || null
        };
      });

      INGREDIENT_KEYS = Object.keys(INGREDIENT_DATA).sort((a,b)=>{
        const la = INGREDIENT_DATA[a].label.toLowerCase();
        const lb = INGREDIENT_DATA[b].label.toLowerCase();
        return la.localeCompare(lb);
      });

      ingredientsLoaded = true;
    }catch(err){
      console.error("Failed to load ingredients.csv", err);
    }
  }

  (async function init(){
    if(!window.SHOW_INTERNAL_HEADER){
      const h = document.getElementById("internalHeader");
      if(h) h.style.display="none";
    }
    await tryMergeExternal();
    seedIng();
    seedUnits();
    render();
  })();
</script>
</body>
</html>
